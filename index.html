<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <style>
    #chart {
      font-family: Helvetica, Arial;
      font-size: 11px;
      width: 1200;
      /* box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19); */
      top: 50px;
    }

    .node rect {
      fill-opacity: .9;
      shape-rendering: crispEdges;
    }

    .node text {
      pointer-events: none;

    }

    .link {
      fill: none;
      stroke: #000;
      stroke-opacity: .05;
      stroke-width: 1px;
    }


    .gradient-link {
      fill: none;
      stroke-opacity: .75;
    }


    h1 {
      font-size: 1.4rem;
    }

    /* This is to remove the underline below the twitter links in the footer */
    a:hover,
    a:focus,
    a:active,
    a:visited,
    a:link {
      text-decoration: none;
    }

    .svg-container {
      display: inline-block;
      position: relative;
      width: 100%;
      padding-bottom: 50%;
      vertical-align: top;
      overflow: hidden;
    }

    .svg-content-responsive {
      display: inline-block;
      position: absolute;
      top: 50px;
      left: 0;
    }

    .navbar {
      overflow: hidden;
      background-color: #333;
      position: fixed;
      /* Set the navbar to fixed position */
      top: 0;
      /* Position the navbar at the top of the page */
      width: 100%;
      /* Full width */
    }
  </style>
</head>

<body>

  <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
    <a class="navbar-brand">
      <font color="blue">Aptivaa</font>
    </a>

    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <a class="nav-link" href="#">Home</a>
      </li>
      <li class="nav-item">
        <a class="nav-link " href="#overview">IST Engine Overview</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#shock">Visualiser</a>
      </li>
      <li class="nav-item">
        <a class="nav-link " href="#Architecture">IT Architecture</a>
      </li>
      <li class="nav-item">
        <a class="nav-link " href="#Offerings">Our Offerings</a>
      </li>
    </ul>
    <form class="form-inline mt-2 mt-md-0">
      <!-- <img src="aptivaa.png" style="position:absolute;top:0px;right:0px;" height="75" width="200" /> -->
    </form>
    </div>
  </nav>

  <!-- <img src="aptivaa.png" style="position:absolute;top:0px;right:0px;" height="75" width="200" /> -->



  <div class="jumbotron">

    <h1 class="display-4">Integrated Stress Testing</h1>
    <p class="lead">This is a visualiser to demonstrate shock tranmission mechanisms in an ideal integrated stress
      testing engine.</p>
    <hr class="my-4">
    <div>
      <br><br>
      <br><br>
      <p>The IST framework not only covers all material risks but also takes into account inter-dependencies between the
        risk types, thus establishing an integrated framework. The impact is assessed not just across Credit, Market,
        Liquidity and other risks independently, but the cross-dependencies are accounted for dynamically.For instance,
        while a ‘global recession’ scenario leads to an direct impacts on Liquidity and Credit Risk, the increase in NPL
        ( from increase in Credit Risk) further impacts the Liquidity Ratios. Similarly, NII impacts from Interest Rate
        movements, impact available Capital, and thus impacts Capital Adequacy Ratios (Credit RiskGiven below is an
        illustration of how a single global stress condition leads to multiple risk events being triggered.
        the IST framework is a tightly coupled, dynamic stress testing model, that provides a multi-year P&L and Balance
        sheet forecast under the stress scenarios considered by the Bank
      </p>
    </div>

    <p class="lead">
      <a class="btn btn-primary btn-lg" role="button" href="#shock">Learn more</a>
    </p>
    <br><br><br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <hr class="my-4">
    <div id='overview'><a name="overview">

        <h4>IST Overview</h4>
        <p>this is wip</p>
        <br>
        <p> </p>
      </a></div>
    <br>
    <br>
    <br>
    <br>
    <br>
    <hr class="my-4">

    <div id='shock'><a name="shock">

        <h4>Shock Transmission Mechanism</h4>
      </a></div>

    <p>
      Three types of scenarios are typically chosen
      <ul>
        <li>Bank Specific or Idiosyncratic Scenarios – typically driven by internal drivers
        </li>
        <li>Systemic Scenarios – typically driven by external risk factors driven below(either individually or in
          combination)
        </li>
        <li>Combined scenarios – Impact of one or more of Bank Specific Scenarios and Systemic Scenarios (one or more
          scenarios)
        </li>
      </ul>
    </p>
    <p> You can select from a dropdown to view the impact transmission for a variety of stress scenarios.</p>

    <div align="center">
      <div class="container"></div>
      <!-- <label for="selectButton" >Choose Scenario</label> -->
      <select id="selectButton" style="padding:5px; border: 1px solid grey; border-radius:3px; "> </select>
    </div>


    <div id="chart"></div>
    <div>
      <p>
        The snapshot above focuses on the downstream impacts of stress scenarios on various risk types, and gives an
        overview of how these impacts are translated into impacts on risk indicators like Capital Adequacy, LCR/NSFR,
        NPL ratio, Provisions coverage ratio etc. Tt is a snapshot view of how the stress
        scenario translates into impact across various risk types, which in turn impact projections of Balance Sheet and
        P&L, leading to final impact on various risk indicators
      </p>
    </div>
    <hr class="my-4">

    <div id="Architecture"><a name="Architecture">
        <h4>Technology Architecture</h4>
      </a>
    </div>

    <div id='Offerings'><a name="Offerings">

        <h4>Our Offerings</h4>
      </a>
    </div>
  </div>
  </div>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="sankey.js"></script>

  <script>
    var units = "Nodes";

    // set the dimensions and margins of the graph
    var margin = {
        top: 1,
        right: 1,
        bottom: 10,
        left: 50
      },
      width = 1300 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

    // format variables
    var formatNumber = d3.format(",.0f"), // zero decimal places
      // format = function(d) { return formatNumber(d) + " " + units; }, //replace with units if needed
      format = function (d) {
        return formatNumber(d) + " " + "impacts";
      }, //replace with units if needed
      color = d3.scaleOrdinal(d3.schemeCategory20)

    var svg = d3.select("#chart")
      .append("div")
      .classed("svg-container", true) //container class to make it responsive
      .append("svg")
      //responsive SVG needs these 2 attributes and no width and height attr
      .attr("preserveAspectRatio", "xMinYMin meet")
      .attr("viewBox", "0 0 1300 600")
      //class to make it responsive
      .classed("svg-content-responsive", true);


    // Set the sankey diagram properties
    var sankey = d3.sankey()
      .nodeWidth(15)
      .nodePadding(10)
      .size([width, height]);

    var path = sankey.link();

    // load the data
    d3.csv("sankey.csv", function (error, data) {

      categoryMap = {
        "category": []
      };


      data.forEach(function (d) {
        categoryMap.category.push({
          "category": d.category
        });
      });

      categoryMap.category = d3.keys(d3.nest()
        .key(function (d) {
          return d.category;
        })
        .object(categoryMap.category));


      //Function call to generate D3 chart
      var updateGraph = function (data) {
        d3.selectAll('svg > g > *').remove();

        graph = {
          "nodes": [],
          "links": []
        };
        // console.log("data inside update graph:");
        //console.log(data);
        data.forEach(function (d) {
          graph.nodes.push({
            "name": d.source
          });
          graph.nodes.push({
            "name": d.target
          });
          graph.links.push({
            "source": d.source,
            "target": d.target,
            "value": +d.value
          });
        });


        // return only the distinct / unique nodes
        graph.nodes = d3.keys(d3.nest()
          .key(function (d) {
            return d.name;
          })
          .object(graph.nodes));

        // loop through each link replacing the text with its index from node
        graph.links.forEach(function (d, i) {
          graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
          graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
        });

        // now loop through each nodes to make nodes an array of objects
        // rather than an array of strings
        graph.nodes.forEach(function (d, i) {
          graph.nodes[i] = {
            "name": d
          };
        });

        sankey
          .nodes(graph.nodes)
          .links(graph.links)
          .layout(13);


        function setDash(d) {
          var d3this = d3.select(this);
          var totalLength = d3this.node().getTotalLength();
          d3this
            .attr('stroke-dasharray', totalLength + ' ' + totalLength)
            .attr('stroke-dashoffset', totalLength)
        }

        function branchAnimate(nodeData) {
          var links = svg.selectAll(".gradient-link")
            .filter(function (gradientD) {
              return nodeData.sourceLinks.indexOf(gradientD) > -1
            });
          var nextLayerNodeData = [];
          links.each(function (d) {
            nextLayerNodeData.push(d.target);
          });

          links
            .style("opacity", null)
            .transition()
            .duration(400)
            .transition(d3.easeLinear)
            .attr('stroke-dashoffset', 0)
            .on("end", function () {
              nextLayerNodeData.forEach(function (d) {
                branchAnimate(d);
              });
            });
        } //end branchAnimate

        var gradientLink = svg.append("g").selectAll(".gradient-link")
          .data(graph.links)
          .enter().append("path")
          .attr("class", "gradient-link")
          .attr("d", path)
          .style("stroke-width", function (d) {
            return Math.max(1, d.dy);
          })
          .sort(function (a, b) {
            return b.dy - a.dy;
          })
          .each(setDash)
          .style('stroke', function (d) {
            var sourceColor = color(d.source.name.replace(/ .*/, "")).replace("#", "");
            var targetColor = color(d.target.name.replace(/ .*/, "")).replace("#", "");
            var id = 'c-' + sourceColor + '-to-' + targetColor;
            //append the gradient def
            //append a gradient
            var gradient = svg.append('defs')
              .append('linearGradient')
              .attr('id', id)
              .attr('x1', '0%')
              .attr('y1', '0%')
              .attr('x2', '100%')
              .attr('y2', '0%')
              .attr('spreadMethod', 'pad');

            gradient.append('stop')
              .attr('offset', '0%')
              .attr('stop-color', "#" + sourceColor)
              .attr('stop-opacity', 1);

            gradient.append('stop')
              .attr('offset', '100%')
              .attr('stop-color', "#" + targetColor)
              .attr('stop-opacity', 1);
            a = "url(#" + id + ")";

            return "url(#" + id + ")";

          });




        // add in the links
        var link = svg.append("g").selectAll(".link")
          .data(graph.links)
          .enter().append("path")
          .attr("class", "link")
          .attr("d", path)
          .style("stroke-width", function (d) {
            return Math.max(1, d.dy);
          })
          .sort(function (a, b) {
            return b.dy - a.dy;
          });

        // add the link titles
        link.append("title")
          .text(function (d) {
            return d.source.name + " → " +
              d.target.name + "\n" + format(d.value);
          });



        // add in the nodes
        var node = svg.append("g").selectAll(".node")
          .data(graph.nodes)
          .enter().append("g")
          .attr("class", "node")
          .attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
          })
          .on("mouseover", branchAnimate)
          .on("mouseout", function () {
            //cancel all transitions by making a new one
            gradientLink.transition();
            gradientLink
              .style("opacity", 0)
              .each(function (d) {
                setDash.call(this, d);
              });
          });

        // add the rectangles for the nodes
        node.append("rect")
          .attr("height", function (d) {
            return d.dy;
          })
          .attr("width", sankey.nodeWidth())
          .style("fill", function (d) {
            return d.color = color(d.name.replace(/ .*/, ""));
          })

          .append("title")
          .text(function (d) {
            return d.name + "\n" + format(d.value);
          });

        // add in the title for the nodes
        node.append("text")
          .attr("x", -6)
          .attr("y", function (d) {
            return d.dy / 2;
          })
          .attr("dy", ".35em")
          .attr("text-anchor", "end")
          .attr("transform", null)
          .text(function (d) {
            return d.name;
          })
          .filter(function (d) {
            return d.x < width / 2;
          })
          .attr("x", 6 + sankey.nodeWidth())
          .attr("text-anchor", "start");


      }

      d3.select("#selectButton")
        .selectAll('options')
        .data(categoryMap.category)
        .enter()
        .append('option')
        .text(function (d) {
          return d;
        }) // text showed in the menu
        .attr("value", function (d) {
          return d;
        }) // corresponding value returned by the button

      var initialDropDownvalue = d3.select("#selectButton").property("value");

      update(initialDropDownvalue);
      //console.log("initial Property value : " + initialDropDownvalue);

      d3.select("#selectButton").on("change", function (d) {
        // recover the option that has been chosen

        var selectedOption = d3.select(this).property("value")
        //console.log(selectedOption);
        // run the updateChart function with this selected option
        update(selectedOption)
      })


      function update(selectedGroup) {
        // Create new data with the selection?
        var dataFilter = data.filter(function (d) {
          if (d.category == selectedGroup) {
            return d;
          }
        })

        updateGraph(dataFilter);
      }
      // console.log("printing data 2: " + data.filter);
      // var initialData = data.filter(function(d){
      //   if( d.category =="Collateral depreciation")  
      //   {
      //     return d;
      //   }
      //  })
      // updateGraph(initialData); 
    });
  </script>




  <p style="text-align: center; ">A work by <a href="https://www.aptivaa.com">Aptivaa</a></p>
  <p style="text-align: center;"><span style="color: #808080;"><em>info@aptivaa.com</em></span></p>

  <!-- Add icon library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- Add font awesome icons -->
  <p style="text-align: center;">
    <a href="https://twitter.com/Aptivaa_info" class="fa fa-twitter"></a>
    <a href="https://www.linkedin.com/company/aptivaa/?originalSubdomain=in" class="fa fa-linkedin"></a>
  </p>


</body>